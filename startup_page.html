<html>
    <head>
        <title>Man Page Server</title>
        <style>
        body {
            margin: 0px;
            background-color: black;
            color: white;
            font-family: 'Courier New', Courier, monospace;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        .man-server-container {
            position: relative;
        }
        .man-server-header h1 {
            margin-bottom: 20px;
            text-align: center;
        }
        .man-server-command-form {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        .submit-form input {
            font-family: 'Courier New', Courier, monospace;
            background-color: white;
            color: black;
            border: none;
            padding: 5px 20px;
        }
        .submit-form input:hover {
            cursor: pointer;
            background-color: rgb(234, 234, 234);
        }
        #error {
            color: red;
            text-align: center;
        }
        #option-container {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: #090909;
            box-sizing: border-box;
            white-space: pre-wrap;
            word-wrap: break-word;
            border-radius: 10px;
        }
        </style>
    </head>
<body>
    <div class="man-server-container">
        <div class="man-server-header">
            <h1>Man Page Server</h1>
        </div>
        <form class="man-server-command-form" onsubmit="return formatQuery()">
            <div class="man-page-form">
                <label for="man2html">Man Page:</label>
                <input type="text" autocomplete="off" id="man2html" name="man2html">
            </div>
            <div class="man-section-form">
                <label for="section">Select Section:</label>
                <select id="section" name="section">
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                    <option value="7">7</option>
                    <option value="8">8</option>
                </select>
            </div>
            <div class="submit-form">
                <input type="submit" value="Get Man Page">
            </div>
        </form>
        <div id="option-container">
            <div id="option">Pressing tab in the input provides autocomplete suggestions, similar to the terminal</div>
        </div>
        <div id="error">{error}</div>
    </div>
    <script>
        const KEY = 'man_pages_data'
        const ERROR_ELEMENT = document.getElementById('error')
        const OPTION_ELEMENT = document.getElementById('option')
        var manData = []
        var manLongest = 0

        setup()

        function setup() {
            if (ERROR_ELEMENT.textContent != '')
                OPTION_ELEMENT.textContent = ''

            if(localStorage.key(0) != null) {
                manData = localStorage.getItem(KEY).split(',')
                manLongest = Math.max(...manData.map(manPage => manPage.length))
                return
            }

            console.log('Fetching man pages')
            fetch('/query-potentials')
                .then(response => response.text())
                .then(data => {
                    localStorage.setItem(KEY, data)
                    manData = data.split(',')
                    manLongest = Math.max(...manData.map(manPage => manPage.length))
                })
                .catch(error => console.log('Error fetching data:', error))
        }

        function queryStorage(value) {
            if (!value)
                return formatColumns(0, manData.length, manLongest)

            let startIndex = binarySearch(value)
            if (startIndex == -1)
                return ''

            let endIndex = startIndex;
            let longest = manData[startIndex].length
            for (; endIndex < manData.length; ++endIndex) {
                if (!manData[endIndex].startsWith(value))
                    break

                if (manData[endIndex].length > longest)
                    longest = manData[endIndex].length
            }

            return formatColumns(startIndex, endIndex, longest)
        }

        // Data is sorted alphabetically
        function binarySearch(value) {
            let low = 0;
            let high = manData.length - 1;

            while (low <= high) {
                let mid = ((low + high) / 2) | 0
                if (manData[mid] < value)
                    low = mid + 1
                else
                    high = mid - 1
            }

            return (manData[low] && manData[low].startsWith(value)) ? low : -1;
        }

        function formatColumns(startIndex, endIndex, longest) {
            let output = []
            let num = 0
            const colWidth = longest + 2
            const numOfColumns = 3
            const spaces = ' '.repeat(colWidth)

            for (let i = startIndex; i < endIndex; ++i) {
                output.push(manData[i] + spaces.slice(0, colWidth - manData[i].length))
                if ((num + 1) % numOfColumns === 0)
                    output.push('\n')
                num += 1
            }

            let left = (num % numOfColumns)
            if (left != 0)
                output.push(' '.repeat(colWidth * (numOfColumns - left)) + '\n')

            return output.join('')
        }

        document.getElementById('man2html').addEventListener('keydown', (event) => {
            if (event.key == 'Tab') {
                ERROR_ELEMENT.textContent = ''
                const userInput = document.getElementById('man2html').value.trim()
                OPTION_ELEMENT.textContent = queryStorage(userInput)
                event.preventDefault()
            }
        })

        function formatQuery() {
            const section = document.getElementById('section').value;
            const manPage = document.getElementById('man2html').value;
            const queryString = `cgi-bin/man2html?${section}+${manPage}`
            window.location.href = queryString;
            return false;
        }
    </script>
</body>
</html>